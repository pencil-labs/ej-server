{% from 'components/generic/elements.jinja2' import action_button, breadcrumbs, link %}


{#---------------------------------------------------------------------------#
    CONVERSATION LIST
 #---------------------------------------------------------------------------#}
{% macro conversation_list(conversations,
                           categories,
                           title=_('Active conversations'),
                           subtitle=_('See some active conversations and give your opinion')) %}
    <div class="ConversationList">
        <div class="ConversationList-title">
            {% if caller %}{{ caller() }}{% endif %}
            <h1>{{ title }}</h1>
            <h2>{{ subtitle }}</h2>
        </div>

        {% if categories %}
            <div class="ConversationList-categories">
                <i class="fa fa-chevron-left"></i>
                <ul>
                    <li>{{ link(_('All'), href='/conversations/', class='color-accent') }}</li>
                    {% for category in categories %}
                        <li>{{ link(category, href=category.get_absolute_url()) }}</li>
                    {% endfor %}
                </ul>
                <i class="fa fa-chevron-right"></i>
            </div>
        {% endif %}

        {# Cards #}
        <div class="ConversationList-cardList">
            {% for conversation in conversations %}
                {{ conversation_card(conversation) }}
            {% endfor %}
        </div>
        {# {{ conversation_pagination() }} #}
    </div>
{% endmacro %}


{% macro conversation_card(conversation) %}
    <div class="ConversationCard">
        <div class="ConversationCard-cover">
            <h1 up-expand>
                <a href="{{ conversation.get_absolute_url() }}" alt="alt">{{ conversation.question }}</a>
            </h1>
            <dl>
                <dt>Assunto:</dt>
                <dd><a href="{{ conversation.category.get_absolute_url() }}">{{ conversation.category_name }}</a></dd>
            </dl>
        </div>
        <div class="ConversationCard-actions">
            <ul class="ConversationCard-statistics">
                <li>{{ gettext('%(count)s comments', count=conversation.comments.count()) }}</li>
                <li>{{ gettext('%(count)s votes', count=conversation.votes.count()) }}</li>
            </ul>
            {{ action_button('Participar <i class="fa fa-comments"></i>', conversation.get_absolute_url()) }}
        </div>
    </div>
{% endmacro %}

{% macro conversation_pagination() %}
    <div class="ConversationPagination">
        <div class="ConversationPagination-pager">
            <a href="prev">&lt;</a> ... <a href="prev">&gt;</a>
        </div>
    </div>
{% endmacro %}

{#---------------------------------------------------------------------------#
    CONVERSATION DETAIL
 #---------------------------------------------------------------------------#}

{% macro conversation_detail(conversation, user) %}
    {% set category = conversation.category %}

    <div class="ConversationDetail">
        <div class="ConversationDetail-banner">
            <h1>{{ conversation.question }}</h1>
            <ul class="ConversationDetail-statistics">
                <li>{{ gettext('%(count)s comments', count=conversation.comments.count()) }}</li>
                <li>{{ gettext('%(count)s votes', count=conversation.votes.count()) }}</li>
            </ul>
        </div>
        <div class="ConversationDetail-arrow"></div>

        <ul class="ConversationDetail-statisticsBottom">
            <li>
                <div>{{ _('category:') }}</div>
                <div>{{ link(category.name, href=category.get_absolute_url()) }}</div>
            </li>
            <li>{{ link(_('see more<br>categories'), href='/conversations/') }}</li>
        </ul>

        {# Current comment #}
        <div class="ConversationDetail-header">
            <h1>Opiniões da comunidade</h1>
            <p>Interaja com as opiniões da comunidade selecionando um dos botões
                de opção.</p>
        </div>

        {% if comment %}
            {{ comment_detail(comment, user) }}
        {% else %}
            <p class="Comment">Conversa não contêm comentários</p>
        {% endif %}

        {# Post a new comment #}
        {% if user.is_authenticated %}
            {{ comment_form() }}
        {% endif %}

        {# Opinion #}
        {% if conversation.opinion %}
            {{ opinion(conversation) }}
        {% endif %}
    </div>
{% endmacro %}


{% macro comment_detail(comment, user) %}
    <div class="Comment">
        <div class="Comment-user">
            <i class="fa fa-user"></i><span>{{ comment.author.name }}</span>
        </div>
        <p>{{ comment.content }}</p>
        {% if user.is_authenticated %}
            <form method="post" class="Comment-voteArea" id="Comment-form" up-target=".ConversationDetail-statistics, .Comment">
                {{ csrf_input }}
                <input type="hidden" name="action" value="vote">
                <ul class="ConversationComment-actions">
                    <li up-expand>
                        <button type="submit" form="Comment-form" name="vote" value="agree">
                            <i class="fa fa-check"></i>
                        </button>
                        <span>{{ _('Agree') }}</span>
                    </li>
                    <li up-expand>
                        <button type="submit" form="Comment-form" name="vote" value="skip">
                            <i class="fa fa-arrow-right"></i>
                        </button>
                        <span>{{ _('Skip') }}</span>
                    </li>
                    <li up-expand>
                        <button type="submit" form="Comment-form" name="vote" value="disagree">
                            <i class="fa fa-times"></i>
                        </button>
                        <span>{{ _('Disagree') }}</span>
                    </li>
                </ul>
            </form>
        {% else %}
            <p class="Comment-loginWarn">É necessário <a
                    href="/login/?next={{ comment.conversation.get_absolute_url() }}">registrar-se</a> antes de
                votar ou enviar um comentário!</p>
        {% endif %}
    </div>
{% endmacro %}


{% macro comment_form() %}
    <div class="CommentForm">
        <h1>Deixe a sua opinião</h1>
        <p>Inclua uma nova opinião. Evite postar opiniões semelhantes a outros
            usuários.
        </p>
        <form method="post">
            {{ csrf_input }}
            <input type="hidden" name="action" value="comment">
            <textarea name="comment"></textarea>
            <input type="submit" name="submit" value="Opinar" primary>
        </form>
    </div>
{% endmacro %}

{% macro opinion(conversation) %}
    <article class="ConversationOpinion">
        <h1>...</h1>
        <h2>Nossa opinião</h2>
        <p>{{ conversation.opinion }}</p>
    </article>
{% endmacro %}


{#---------------------------------------------------------------------------#
    AUXILIARY
 #---------------------------------------------------------------------------#}

{% macro conversation_breadcrumbs(conversation, has_home=True) %}
    {% set links = [
        ('conversations', 'Conversas'),
        (conversation.category.slug, conversation.category.name),
        (conversation.slug, conversation.title),
    ] %}
    {{ breadcrumbs(links, has_home=has_home) }}
{% endmacro %}


{% macro category_breadcrumbs(category, has_home=True) %}
    {% set links = [
        ('conversations', 'Conversas'),
        (category.slug, category.name),
    ] %}
    {{ breadcrumbs(links, has_home=has_home) }}
{% endmacro %}


{#---------------------------------------------------------------------------#
    CONVERSATION INFO
 #---------------------------------------------------------------------------#}
{% macro conversation_info(conversation, info) %}
    <div class="ConversationInfo Container">
        <h1>Info: <em>{{ conversation.title }}</em></h1>
        <article>
            <dl>
                {% for name, value in info.items() %}
                    <dt>{{ name }}</dt>
                    {% if value.__class__ == dict %}
                        <dd>
                            <dl>
                                {% for k, v in value.items() %}
                                    <dt>{{ k }}</dt>
                                    <dd>{{ v }}</dd>
                                {% endfor %}
                            </dl>
                        </dd>
                    {% else %}
                        <dd>{{ value }}</dd>
                    {% endif %}
                {% endfor %}
            </dl>
        </article>

        <h1>Comments</h1>
        <table>
            <thead>
            <tr>
                <th>Comment</th>
                <th>Author</th>
                <th>Votes</th>
                <th>Agree</th>
                <th>Disagree</th>
                <th>Skip</th>
                <th>Unvoted</th>
            </tr>
            </thead>
            <tbody>
            {% for comment in conversation.comments.all() %}
                <tr>
                    {% set stats = comment.get_statistics(ratios=True) %}
                    <td>{{ comment.content }}</td>
                    <td>{{ comment.author.name }}</td>
                    <td>{{ stats.total }}</td>
                    <td>{{ stats.agree_ratio | pc }}</td>
                    <td>{{ stats.disagree_ratio | pc }}</td>
                    <td>{{ stats.skip_ratio | pc }}</td>
                    <td>{{ stats.missing_ratio | pc }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endmacro %}
